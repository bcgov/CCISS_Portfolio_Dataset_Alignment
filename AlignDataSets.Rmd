---
title: "Compile Tree by Site Series Info"
author: "Kiri Daust/Will MacKenzie"
date: "04/06/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE)
require(dplyr)
require(ggplot2)
require(MASS)
require(magrittr)
require(foreach)
require(reshape2)
require(reticulate)
require(Rcpp)
library(gridExtra)
library(data.table)
library(scales)
library(tidyr)
library(magrittr)
library(ggthemes)
library(flextable)
require(rgdal)
require(tmap)
library(sf)
```

Load data

```{r load data sets}
##Set drive with cloud data
if(dir.exists("C:/users/whmacken/Sync")){
  cloud_dir <- "C:/users/whmacken/Sync/CCISS_data/CommonTables/"
}else{
  cloud_dir <- "C:/Users/kirid/Sync/CCISS_data/CommonTables/"
}

###Read in data
## 1. All BGCS (info table from USA_BGC project)
bgc <- fread(paste0(cloud_dir,"All_BGCs_v11_21.csv"))
bgc_small <- bgc[,.(Source,Zone,BGC = Map_Label)]

## 2. All Site Series (info table from from USA_BGC project)
ss <- fread(paste0(cloud_dir, "WNA_SSeries_v11.csv"))
ss_small <- ss[,.(BGC, SS_NoSpace)]

## 3. All Edatopic (info table from USA_BGC project)
eda <- fread(paste0(cloud_dir, "Edatopic_v11_20.csv"))
eda_small <- eda[,.(SS_NoSpace,Edatopic,Special,Codes)]

## 4. All aSMR (modelled in aSMR_X_rSMR project)
asmr <- fread(paste0(cloud_dir, "modelled_WNAv11_rSMR_aSMR_grid_HalfStep.csv"))

## 5. All Feasibility (in part modelled in TreeSuitabilityPrediction project)
feasible <- fread(paste0(cloud_dir, "Feasibility_v11_21.csv"))
feas_small <- feasible[,.(SS_NoSpace, Spp, Feasible)]

## 6. All Site Index (modelled in SIBEC_Modelled project)
sibec <- fread(paste0(cloud_dir, "PredSI_May2020.csv"))

## 7. SIBEC 2013 summarised
sibec13 <- fread(paste0(cloud_dir, "SIBEC_2013_Summary.csv"))
colnames(sibec13)[2:3] <- c("Spp","SI13")
```
   
These are the duplicates in each table

```{r duplicates}
outFold <- "./Duplicated/"
any(duplicated(bgc_small))
any(duplicated(ss_small))
ss_small[, fD := .N > 1, by = .(SS_NoSpace)]
fwrite(ss_small[(fD)], paste0(outFold,"SiteSeries.csv"))
ss_small[,fD := NULL]
ss_small <- unique(ss_small)
any(duplicated(sibec))
sibec[,fD := .N > 1, by = .(SS_NoSpace,Spp)]
fwrite(sibec[(fD)], paste0(outFold,"Sibec.csv"))
sibec <- unique(sibec[,!"fD"], by = c("SS_NoSpace","Spp"))
any(duplicated(feas_small))
feas_small[,fD := .N > 1, by = .(SS_NoSpace,Spp)]
fwrite(feas_small[(fD)],paste0(outFold,"Feasibility.csv"))
feas_small <- unique(feas_small[,!"fD"], by = c("SS_NoSpace","Spp"))
any(duplicated(eda_small))
eda_small[,fD := .N > 1, by = .(SS_NoSpace,Edatopic,Special)]
fwrite(eda_small[(fD)],paste0(outFold,"Edatopic.csv"))
eda_small <- unique(eda_small[,!"fD"])
sibec13 <- unique(sibec13)
```

```{r find_missing}

setkey(bgc_small,BGC)
setkey(ss_small,BGC,SS_NoSpace)
bgc_ss <- merge(bgc_small, ss_small, all = T)
bgc_NoSS <- bgc_ss[is.na(BGC),.(SS_NoSpace)]
ss_NoBGC <- bgc_ss[is.na(SS_NoSpace),.(BGC)]

setkey(feas_small, SS_NoSpace, Spp)
ss_feas <- merge(ss_small, feas_small, by = "SS_NoSpace", all = T)
ss_NoFeas <- ss_feas[is.na(Spp),.(SS_NoSpace)]
feas_NoSS <- ss_feas[is.na(BGC),.(SS_NoSpace)]

setkey(sibec, SS_NoSpace, Spp)
ss_feas_sibec <- merge(ss_feas, sibec, by = c("SS_NoSpace","Spp"), all = T)

sibec_missingSpp <- ss_feas_sibec[,all(is.na(SIPred)), by = Spp][(V1),.(Spp)]
sibec_missingSS <- ss_feas_sibec[,all(is.na(SIPred)), by = SS_NoSpace][(V1),.(SS_NoSpace)]
temp <- ss_feas_sibec[(!Spp %in% sibec_missingSpp) & (!SS_NoSpace %in% sibec_missingSS),]
##add SIBEC 2013 approximation
ss_feas_sibec <- merge(ss_feas_sibec, sibec13, by = c("SS_NoSpace","Spp"),all = T)


setkey(eda_small,SS_NoSpace)
ss_eda <- merge(ss_small, eda_small, all = T)

setkey(asmr, BGC)
bgc_asmr <- merge(bgc_small, asmr, all = T)
asmr_NoBGC <- bgc_asmr[is.na(rSMR0),.(BGC)]
bgc_NoASMR <- bgc_asmr[is.na(Zone),.(BGC)]

outFold <- "./Missing/"
fwrite(bgc_NoSS, paste0(outFold, "BGC!SS.csv"))
fwrite(ss_NoBGC, paste0(outFold, "SS!BGC.csv"))
fwrite(ss_NoFeas, paste0(outFold, "SS!Feas.csv"))
fwrite(feas_NoSS, paste0(outFold, "Feas!SS.csv"))
fwrite(sibec_missingSpp, paste0(outFold, "Feas!SI_Spp.csv"))
fwrite(sibec_missingSS, paste0(outFold, "Feas!SI_SS.csv"))
fwrite(asmr_NoBGC, paste0(outFold, "aSMR!BGC.csv"))
fwrite(bgc_NoASMR, paste0(outFold, "BGC!aSMR.csv"))
```

1. There are no BGCs without a matching SS. SS without matching BGCs are `r ss_NoBGC`.
2. There are a lot of SS without matching feasibility entries (`r ss_NoFeas`) and vice versa (`r feas_NoSS`)
3. Understandably, there is a lot of missing SIBEC data. Species which are not included in the dataset are `r sibec_missingSpp`, and site series with no SIBEC data are `r sibec_missingSS`.
4. The edatopic grid matches perfectly with the site series
5. BGCs with no aSMR data: `r bgc_NoASMR`, aSMR without matching BGCs: `r asmr_NoBGC`.
